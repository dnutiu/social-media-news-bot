workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE =~ /^(\[Draft\]|\(Draft\)|Draft:)/
      when: never
    - when: always
stages:
  - lint
  - test
  - build

variables:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

default:
  image: rust:1.92-bullseye
  cache:
    key: "$CI_PROJECT_NAME-cargo"
    paths:
      # Cache downloaded crates and git repos
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
      # Cache build artifacts (compiled dependencies)
      - target/
  before_script:
    - rustc -V
    - cargo -V
    - rustup component add clippy rustfmt || true

lint:clippy:
  stage: lint
  script:
    - cargo clippy --workspace --all-targets -- -D warnings

lint:fmt:
  stage: lint
  script:
    - cargo fmt --all -- --check

test:
  stage: test
  services:
    - name: redis/redis-stack-server:6.2.6-v17
      alias: redis
  variables:
    # If your tests read the Redis URL from env, point to the service hostname
    REDIS_TESTS_URL: redis://redis:6379
  before_script:
    - rustc -V && cargo -V
    # Install redis-cli to wait for the Redis service to be ready
    - apt-get update && apt-get install -y --no-install-recommends redis-tools >/dev/null
    - |
      echo "Waiting for Redis to be ready..."
      for i in {1..60}; do
        redis-cli -h redis -p 6379 ping && break
        sleep 1
      done
      echo "Redis PING: $(redis-cli -h redis -p 6379 ping)"
  script:
    - cargo test --workspace --all-features --no-fail-fast -- --nocapture

.docker-build:
  stage: build
  image: docker:24.0.5-cli
  services:
    - name: docker:24.0.5-dind
      alias: docker
  tags:
    - priviledged
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  cache: []
  before_script:
    - |
      for i in {1..30}; do
        docker info >/dev/null 2>&1 && break
        echo "Waiting for docker daemon..."
        sleep 1
      done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:bot:
  extends: .docker-build
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/bot
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA -t $IMAGE_NAME:latest -f bot/docker/Dockerfile .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest

build:scrapper:
  extends: .docker-build
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/scrapper
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA -t $IMAGE_NAME:latest -f scrapper/docker/Dockerfile .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest
